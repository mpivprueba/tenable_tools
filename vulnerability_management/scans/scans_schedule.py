"""
scans_schedule.py

Provides functions to schedule and launch scans in Tenable.io using the API.

Functions:
- schedule_scan: Schedules a scan with a given recurrence rule.
- launch_scan: Launches a scan immediately.
"""

import requests
from config import BASE_URL
from api_utils import get_headers


def schedule_scan(scan_id, rrule="FREQ=DAILY;INTERVAL=1"):
    """
    Schedules a scan in Tenable.io with a specified recurrence rule.

    Args:
        scan_id (int or str): The ID of the scan to schedule.
        rrule (str): Recurrence rule in RFC 5545 RRULE format (default: daily).

    Returns:
        None. Prints success or error messages.
    """
    headers = get_headers()

    # Retrieve full scan information to verify if scheduling is allowed
    url_info = f"{BASE_URL}/scans/{scan_id}"
    response = requests.get(url_info, headers=headers)

    if response.status_code != 200:
        print(f"Failed to retrieve information for scan {scan_id}. Status code: {response.status_code}")
        return

    scan_info = response.json()

    if not scan_info.get("enabled", True):
        print(f"Scan {scan_id} is disabled and cannot be scheduled or launched.")
        return

    # Check if the scan supports scheduling
    if "schedule" not in scan_info or not scan_info["schedule"]:
        print(f"Scan {scan_id} does not support scheduling. Launching immediately instead...")
        launch_scan(scan_id)
        return

    # Prepare payload to set the schedule
    url_schedule = f"{BASE_URL}/scans/{scan_id}/schedule"
    payload = {
        "enabled": True,
        "schedule": {
            "rrules": rrule
        }
    }

    response = requests.put(url_schedule, headers=headers, json=payload)

    if response.status_code == 200:
        print(f"Scan {scan_id} scheduled successfully.")
    else:
        try:
            error_msg = response.json().get("error", "Failed to set schedule.")
        except Exception:
            error_msg = "Unknown error."
        print(f"Error scheduling scan {scan_id}. Status code: {response.status_code}. Details: {error_msg}")


def launch_scan(scan_id):
    """
    Launches a scan immediately in Tenable.io.

    Args:
        scan_id (int or str): The ID of the scan to launch.

    Returns:
        None. Prints success or error messages.
    """
    url = f"{BASE_URL}/scans/{scan_id}/launch"
    response = requests.post(url, headers=get_headers())

    if response.status_code == 200:
        print(f"Scan {scan_id} launched successfully.")
    else:
        try:
            error_msg = response.json().get("error", "Failed to launch scan.")
        except Exception:
            error_msg = "Unknown error."
        print(f"Error launching scan {scan_id}. Status code: {response.status_code}. Details: {error_msg}")